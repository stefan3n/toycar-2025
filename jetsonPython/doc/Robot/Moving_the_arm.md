### [< back](../GuideForDocumentation.md)
# Moving the arm
### I use a code which receive some commands: CMD_PING, CMD_STOP, CMD_MOVE_ONE, CMD_MOVE_BOTH, CMD_EMERGENCY, CMD_END_EMERGENCY, CMD_ROTATE_RIGHT, CMD_ROTATE_LEFT, CMD_START_POSITION_JETSON, CMD_INITIAL_POS, CMD_CALIBRATE_LEFT, CMD_CALIBRATE_RIGHT, CMD_CLAW_OPEN, CMD_CLAW_CLOSE, CMD_FINAL_COMMAND and CMD_ROTATE_CLAW. 
  1. CMD_PING is a command that is used to show the Jetson that the Arduino is still connected, but also send the start position to save it in a file. This is a mwthod to keep the relative position to the initial position. This command doesn't need any arguments, and send errors in some situation. ERROR_BAD_MSG is sent only if the car is executing CMD_FINAL_COMMAND or the arm is in emergency. ERROR_ARGUMENTS_LENGHT is send if the command has too few arguments.
  2. CMD_STOP is used to stop the arm. If this command is given while the arm is moving then it will stop. 
  3. CMD_MOVE_ONE will receive 2 numbers as arguments: first one is the actuator you move, and the second one is the new position for actuator( in millimeters).
  4. CMD_MOVE_BOTH is used to move the joints in the same time and it have 2 arguments: the new positions for every join in this order: first one is for first actuator (ACTUATOR1) and second value is for second actuator (ACTUATOR2). To move the arms I compare the feedback value with a target position. If the target position is in an error margin then I consider that I am the position I want. To move the actuator I call a function: moveActuator which has these arguments: the actuator I want to move and the new position. Also to protect the claw I use forward kinematics and I check if the top of the arm is under a specific height to the ground. If it is not then I continue to move, otherwise I check if the final position is safe for claw. In this case I move the arm, if not, I will keep the arm in the same position.
  5. CMD_EMERGENCY is a command that will stop the arm while moving and will enter in a state such that it will not respond at any command until you send CMD_END_EMERGENCY.
  6. CMD_END_EMERGENCY is a command that will exit the emergency state. 
  7. CMD_ROTATE_LEFT and CMD_ROTATE_RIGHT are used to rotate the arm in specific directions. The commands need the number of steps. I use a global variable that holds the relative position and it will be incremented at every loop.
  8. CMD_START_POSITION_JETSON is a command that is used to read the start position form Jetson Orin Nano and send it to the Arduino. With this method we can keep the relative position from the initial position although the power supply is stopped.
  9. The command CMD_INITIAL_POS will move the arm to a specific position, when the command is given, but also at setup. To keep the relative position of the stepper we use the ping signal. This signal is used to inform the Jetson that the Arduino is still connected. This ping will send the relative position to the Jetson and it will write in a file. In this way we can keep the relative position of the stepper even if the power supply is stopped (accidentally or not). For the actuators we use 2 global variables and we will compare them with the current position of the actuator. To move the arm and rotate it at the same time you should give 2 commands: one to move it and one to rotate it.
  10. CMD_CALIBRATE_LEFT and CMD_CALIBRATE_RIGHT will be connected to the server. With these two we can recalibrate the arm by rotating to the right or to the left. The position we fixed will be considered the initial position for the arm.
  11. CMD_CLAW_OPEN is a command with no arguments which opens the claw at maximum position to grab an object.
  12. CMD_CLAW_CLOSE is a command with no arguments which will close the claw at maximum, such that the claw can grab the object and keep it.
  13. CMD_ROTATE_CLAW is a command with one argument: the angle of the claw, and will rotate it to the wanted position. To do this I use a global variable called angle_claw, and in it I write the new position.
  14. CMD_FINAL_ARM is a command that will move the arm such that it can grab a bottle. This command is blocking, except for the command to stop, any other command you send after 5 seconds the arm will not respond. After this time you can send any command. This command will receive the direction to move the arm (0 for left and anything not null for right), the angle in degree for stepper to rotate, x, y positions of the object (x meaning the distance from the bottom join, and y the height where to go down), an angle in degree meaning the how much the claw should rotate. Before the arm will execute the command the claw will open automatically. After the arm goes down, the claw will close automatically after 4 seconds when the command is sent, and after another second the arm will rise the bottle.
### To protect the battery life I write low on the enable pin, also this command prevents the stepper from overheating and can help to prevent the arm's rotation while the car is moving. The stepper is rotating the arm by calculating the number of steps and in the loop I move with one step at every iteration. The rotation is finished when the new target position is equal with step counter (stepCount). Also in the end you should be cautious about fine tuning for the arm. In some situations the arm can reach a level too low such that it hits  the bottle and this may affect the claw. To solve this problem during fine tuning I search for values that prevent them, trying until I obtain the results I want.
##### To determine if the arm is in the emergency state I use a boolean global variable that is set only in these 2 commands: CMD_EMERGENCY and CMD_END_EMERGENCY. If this variable is true then I am in an emergency state, and I will accept only the command CMD_END_EMERGENCY, which will set this variable to false.
##### $$\color{red}WARNING!$$ When you send the CMD_EMERGNECY while the arm is rotating (when CMD_FINAL_ARM is send), it will contine the rotation to it's target and after this will enter in emergency. If the rotation is complete and you send CMD_EMERGENCY the arm is stopped, but after you send CMD_END_EMERGENCY the arm will contiune his movement and for the CMD_FINAL_ARM will not close the claw in the end.
